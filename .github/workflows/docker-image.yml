name: Check Docker Hub Tags, Build and Push

on:
  schedule:
    - cron: '0 2,14 * * *'
  workflow_dispatch:  # Allows manual triggering

jobs:
  check-and-build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Check Docker Hub for tag updates
      id: check_tags
      run: |
        # Define Docker Hub repository details
        REPO="nextcloud"
        IMAGE="nextcloud"

        # Fetch the latest tags from Docker Hub
        curl -s "https://hub.docker.com/v2/namespaces/library/repositories/nextcloud/tags?page_size=100" -o tags.json
        
        # Extract tag details
        TAG_28_APACHE=$(jq -r '.results[] | select(.name=="28-apache") | .last_updated' tags.json)
        TAG_27_APACHE=$(jq -r '.results[] | select(.name=="27-apache") | .last_updated' tags.json)
        TAG_26_APACHE=$(jq -r '.results[] | select(.name=="26-apache") | .last_updated' tags.json)

        # Save tag details for comparison
        echo "TAG_28_APACHE=$TAG_28_APACHE" >> $GITHUB_ENV
        echo "TAG_27_APACHE=$TAG_27_APACHE" >> $GITHUB_ENV
        echo "TAG_26_APACHE=$TAG_26_APACHE" >> $GITHUB_ENV

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Docker Image for master branch
      if: env.TAG_28_APACHE != ''
      run: |
        # Check out the master branch
        git checkout master

        # Build and push Docker image with tag 28-apache and latest
        docker buildx build --push -t cardonaje/nextcloud:28-apache .
        docker buildx build --push -t cardonaje/nextcloud:latest .

    - name: Build and Push Docker Image for nextcloud27 branch
      if: env.TAG_27_APACHE != ''
      run: |
        # Check out the nextcloud27 branch
        git checkout nextcloud27

        # Build and push Docker image with tag 27-apache
        docker buildx build --push -t cardonaje/nextcloud:27-apache .

    - name: Build and Push Docker Image for nextcloud26 branch
      if: env.TAG_26_APACHE != ''
      run: |
        # Check out the nextcloud26 branch
        git checkout nextcloud26

        # Build and push Docker image with tag 26-apache
        docker buildx build --push -t cardonaje/nextcloud:26-apache .
